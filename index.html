<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Número d'Expedient</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #121812;
        }
        .btn-generar {
            background-color: #22c55e;
            color: #121812;
            transition: background-color 0.3s ease;
        }
        .btn-generar:hover {
            background-color: #4ade80;
        }
        .btn-generar:disabled {
            background-color: #166534;
            cursor: not-allowed;
        }
        .btn-copy {
            background-color: transparent;
            border: 2px solid #4ade80;
            color: #4ade80;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            min-width: 110px; /* Amplada mínima per evitar que canviï de mida */
        }
        .btn-copy:hover {
            background-color: #4ade80;
            color: #121812;
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen text-green-400">

    <div class="text-center p-8 rounded-lg shadow-2xl max-w-md w-full" style="background-color: #1c281c;">
        <h1 class="text-3xl font-bold mb-8">Generador de Número d'Expedients</h1>
        
        <button id="generarBtn" class="btn-generar font-bold py-3 px-6 rounded-lg text-lg mb-6">
            GENERAR EXPEDIENT
        </button>
        
        <div id="resultat" class="hidden mt-4 p-4 border-2 border-green-500 rounded-lg bg-black bg-opacity-20">
            <h2 class="text-xl font-semibold">El teu número d'expedient és:</h2>
            <div class="flex items-center justify-center mt-2 space-x-4">
                <p id="pResultatExpedient" class="text-2xl font-mono"></p>
                <button id="copyBtn" class="btn-copy hidden">Copiar</button>
            </div>
        </div>

        <div id="error" class="text-red-500 mt-4 font-semibold"></div>
    </div>

    <script>
        const generarBtn = document.getElementById('generarBtn');
        const copyBtn = document.getElementById('copyBtn');
        const pResultat = document.getElementById('pResultatExpedient');
        const resultatDiv = document.getElementById('resultat');
        const errorDiv = document.getElementById('error');

        generarBtn.addEventListener('click', async () => {
            resultatDiv.classList.add('hidden');
            copyBtn.classList.add('hidden');
            copyBtn.textContent = 'Copiar'; // Reseteja el text del botó de copiar
            errorDiv.textContent = '';
            generarBtn.disabled = true;
            generarBtn.textContent = 'Generant...';

            try {
                // PAS 1: Demanar el token
                const tokenResponse = await fetch('https://www.arcgis.com/sharing/rest/oauth2/token?client_id=k0gInzwOWOcJVqoV&client_secret=2eb5e05c126243bc9bf9f706b87c0f45&grant_type=client_credentials&expiration=1440&f=json', { method: 'POST' });
                if (!tokenResponse.ok) throw new Error('No s\'ha pogut obtenir el token d\'autenticació.');
                const tokenData = await tokenResponse.json();
                const token = tokenData.access_token;

                // PAS 2: Consultar l'últim registre per OBJECTID
                const queryUrl = `https://services-eu1.arcgis.com/jukYmBukbIJBEB9m/arcgis/rest/services/survey123_dddbaf4e75c24ecaae39c1b6bfa0d201_form/FeatureServer/0/query`;
                const params = new URLSearchParams({
                    where: "(_id IS NOT NULL) AND (_id <> '')",
                    outFields: '_id',
                    orderByFields: 'OBJECTID DESC', 
                    resultRecordCount: 1,
                    f: 'json',
                    token: token
                });

                const featureResponse = await fetch(`${queryUrl}?${params.toString()}`);
                if (!featureResponse.ok) throw new Error("Error en consultar l'últim expedient.");
                const featureData = await featureResponse.json();

                let ultimNumero = 0;
                if (featureData.features && featureData.features.length > 0) {
                    const atributs = featureData.features[0].attributes;
                    if (atributs && atributs._id) {
                        const expedientCompletAnterior = atributs._id;
                        const partNumericaStr = expedientCompletAnterior.slice(-4);
                        const numConvertit = parseInt(partNumericaStr, 10);
                        if (!isNaN(numConvertit)) {
                            ultimNumero = numConvertit;
                        } else {
                            throw new Error(`El format de l'expedient rebut ('${expedientCompletAnterior}') no és correcte.`);
                        }
                    }
                }
                
                // PAS 3: Crear el nou número d'expedient
                const nouNumero = ultimNumero + 1;
                const anyActual = new Date().getFullYear();
                const numExpedientFormatat = String(nouNumero).padStart(4, '0');
                const nouExpedient = `${anyActual}-EXP${numExpedientFormatat}`;

                // Mostrar el resultat
                pResultat.textContent = nouExpedient;
                resultatDiv.classList.remove('hidden');
                copyBtn.classList.remove('hidden');

            } catch (error) {
                errorDiv.textContent = `Error: ${error.message}`;
            } finally {
                generarBtn.disabled = false;
                generarBtn.textContent = 'GENERAR EXPEDIENT';
            }
        });

        // Lògica de còpia que funciona sempre
        copyBtn.addEventListener('click', () => {
            const textACopiar = pResultat.textContent;
            if (!textACopiar) return;

            // Mètode universal: crear un element temporal per copiar
            const textArea = document.createElement("textarea");
            textArea.value = textACopiar;
            // Evita que la pantalla faci un "salt" en afegir l'element
            textArea.style.position = "absolute";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            
            textArea.select(); // Selecciona el text dins del textarea
            
            try {
                // Executa l'ordre de còpia del navegador
                document.execCommand('copy');
                // Si té èxit, canvia el text del botó
                copyBtn.textContent = 'Copiat ✓';
            } catch (err) {
                console.error("No s'ha pogut copiar", err);
                copyBtn.textContent = 'Error';
            }
            
            // Elimina l'element temporal
            document.body.removeChild(textArea);

            // Fa que el botó torni a l'estat original passats 2 segons
            setTimeout(() => {
                copyBtn.textContent = 'Copiar';
            }, 2000);
        });
    </script>
</body>
</html>
